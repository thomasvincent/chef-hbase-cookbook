---
name: CI

on:
  push:
    branches: [main, master]
  pull_request:
    branches: [main, master]
  schedule:
    - cron: '0 0 * * 0'  # Run weekly to catch dependency issues

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install dependencies
        run: bundle install

      - name: Run Cookstyle
        run: bundle exec cookstyle --display-cop-names

  unit:
    runs-on: ubuntu-latest
    needs: lint
    steps:
      - name: Check out code
        uses: actions/checkout@v4
        
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Install dependencies
        run: bundle install

      - name: Run ChefSpec tests
        run: bundle exec rspec spec/unit

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: chefspec-results
          path: spec/reports/
          retention-days: 7

  integration:
    runs-on: ubuntu-latest
    needs: unit
    strategy:
      fail-fast: false
      matrix:
        os: ['ubuntu-22.04', 'debian-11', 'almalinux-9', 'amazonlinux-2023']
        suite: ['default', 'distributed']
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Set up Docker Engine
        uses: docker/setup-buildx-action@v3

      - name: Run Kitchen Test
        run: |
          bundle install
          KITCHEN_YAML=kitchen.yml bundle exec kitchen test ${{ matrix.suite }}-${{ matrix.os }}
        env:
          CHEF_LICENSE: accept-silent

      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: kitchen-${{ matrix.os }}-${{ matrix.suite }}
          path: test-reports/
          retention-days: 7

  verify-chef-versions:
    runs-on: ubuntu-latest
    needs: lint
    strategy:
      fail-fast: false
      matrix:
        chef-version: ['18', '18.2', '18.3']
        os: ['ubuntu-22.04']
    steps:
      - name: Check out code
        uses: actions/checkout@v4
      
      - name: Set up Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.2'
          bundler-cache: true

      - name: Set up Docker Engine
        uses: docker/setup-buildx-action@v3

      - name: Test with Chef ${{ matrix.chef-version }}
        run: |
          bundle install
          KITCHEN_YAML=kitchen.yml CHEF_VERSION=${{ matrix.chef-version }} bundle exec kitchen verify default-${{ matrix.os }}
        env:
          CHEF_LICENSE: accept-silent