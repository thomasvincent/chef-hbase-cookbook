name: CI

on:
  push:
    branches: [main]
  pull_request:
    branches: [main]
  workflow_dispatch:

# Cancel previous runs on the same PR
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: ${{ github.event_name == 'pull_request' }}

# Minimal permissions by default
permissions:
  contents: read

env:
  CHEF_LICENSE: accept-no-persist

jobs:
  lint:
    runs-on: [self-hosted, chef]
    timeout-minutes: 15
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
    - name: Run Cookstyle
      run: bundle exec cookstyle .

  unit-test:
    needs: lint
    runs-on: [self-hosted, chef]
    timeout-minutes: 15
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
    - name: Install Policyfile dependencies
      run: bundle exec chef-cli install Policyfile.rb
    - name: Run ChefSpec
      run: bundle exec rspec spec/

  integration-test:
    needs: unit-test
    runs-on: [self-hosted, chef]
    timeout-minutes: 60
    strategy:
      fail-fast: false
      matrix:
        suite: ['default', 'distributed']
        os: ['ubuntu-2204', 'debian-11', 'almalinux-9', 'amazonlinux-2023']
        include:
          - os: 'ubuntu-2204'
            suite: 'thrift'
          - os: 'ubuntu-2204'
            suite: 'rest'
    steps:
    - uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
    - name: Set up Ruby
      uses: ruby/setup-ruby@v1
      with:
        ruby-version: '3.2'
        bundler-cache: true
    - name: Set up Docker
      uses: docker/setup-buildx-action@v3
    - name: Free disk space
      run: |
        sudo apt-get clean
        sudo rm -rf /usr/share/dotnet
        sudo rm -rf /opt/ghc
        sudo rm -rf /usr/local/share/boost
    - name: Install Policyfile dependencies
      run: bundle exec chef-cli install Policyfile.rb
    - name: Run Test Kitchen
      run: |
        bundle exec kitchen test ${{ matrix.suite }}-${{ matrix.os }}
      env:
        KITCHEN_YAML: kitchen.yml
    - name: Upload kitchen logs on failure
      if: failure()
      uses: actions/upload-artifact@b7c566a772e6b6bfb58ed0dc250532a479d7789f
      with:
        name: kitchen-logs-${{ matrix.suite }}-${{ matrix.os }}
        path: .kitchen/logs/